---
title: JSä¸­çš„äº‹ä»¶å¾ªçŽ¯æœºåˆ¶
tags:
  - JS
  - å­¦ä¹ 
cover: 'https://pic.imgdb.cn/item/65cdd6cf9f345e8d032f5627.jpg'
keywords: å­¦ä¹  å‰ç«¯ JS
categories: å‰ç«¯
abbrlink: 42193
date: 2024-3-1 12:55:12
---

# JS ä¸­çš„äº‹ä»¶å¾ªçŽ¯æœºåˆ¶

è¿™ä¸ªé¢è¯•ç»å¸¸é—®è¯¶ï¼Œä½†æ˜¯æˆ‘å¥½å‡ æ¬¡å›žç­”çš„éƒ½æ˜¯ä¸å°½å¦‚äººæ„ï¼Œè¿™æ¬¡æ¥å¥½å¥½æžæ‡‚ä¸€ä¸‹çœ‹çœ‹ ðŸ˜¡ã€‚

## å•çº¿ç¨‹çš„ JS

é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ JS æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºå•¥ ðŸ˜§ï¼Ÿ

å› ä¸ºä¸€å¼€å§‹è®¾è®¡ä¹‹åˆï¼Œä»–åªæ˜¯ä¸€ä¸ªæµè§ˆå™¨çš„è„šæœ¬è¯­è¨€ï¼Œä¸»è¦å°±æ˜¯æ“æŽ§ DOM å’Œä¸Žç”¨æˆ·äº’åŠ¨ï¼Œå¦‚æžœä»–æ˜¯å¤šçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºçŽ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ª DOMï¼Œè°çŸ¥é“ä¼šå‘ç”Ÿå•¥ã€‚

å½“ç„¶ JS ä¹Ÿå¯ä»¥å¤šçº¿ç¨‹ï¼Œä¸‹é¢å¼•ç”¨[é˜®ä¸€å³°åšå®¢](https://www.ruanyifeng.com/blog/2014/10/event-loop.html)çš„è¯ï¼š

> ä¸ºäº†åˆ©ç”¨å¤šæ ¸ CPU çš„è®¡ç®—èƒ½åŠ›ï¼ŒHTML5 æå‡º Web Worker æ ‡å‡†ï¼Œå…è®¸ JavaScript è„šæœ¬åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å­çº¿ç¨‹å®Œå…¨å—ä¸»çº¿ç¨‹æŽ§åˆ¶ï¼Œä¸”ä¸å¾—æ“ä½œ DOMã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæ–°æ ‡å‡†å¹¶æ²¡æœ‰æ”¹å˜ JavaScript å•çº¿ç¨‹çš„æœ¬è´¨ã€‚

## ä»»åŠ¡é˜Ÿåˆ—

é‚£è¿™æ ·æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½æ”¾åˆ°äº†ä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åŽä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œã€‚ä½†æ˜¯è¿™æ ·åº”è¯¥è¿˜ä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚æœ‰çš„ä»»åŠ¡è®¡ç®—é‡å¾ˆå¤§ï¼Œæœ‰çš„ä»»åŠ¡å ç”¨æ—¶é—´å¾ˆé•¿ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´åŽé¢çš„ä»»åŠ¡æ— æ³•æ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´é¡µé¢å¡æ­»(å› ä¸ºæµè§ˆå™¨çš„æ¸²æŸ“çº¿ç¨‹å’Œ JS çº¿ç¨‹æ˜¯äº’æ–¥çš„)ã€‚

å¦‚æžœæ˜¯å‰è€…ï¼ŒCPU å¿™ä¸è¿‡æ¥ï¼Œå€’ä¹Ÿæ˜¯åˆç†çš„ï¼Œç›´æŽ¥ç­‰å¾…è¿è¡Œç»“æŸå°±è¡Œã€‚ä½†æ˜¯å¦‚æžœæ˜¯åŽè€…ï¼ŒCPU ç©ºé—²ï¼Œä½†æ˜¯å› ä¸º IO è®¾å¤‡æ…¢ï¼Œå…¸åž‹çš„å°±æ˜¯ä»Žç½‘ç»œæŽ¥å£åŽåŽ»æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±æ²¡å¿…è¦ç­‰å¾…ä»–ï¼Œå¯ä»¥å…ˆåŽ»å¤„ç†åˆ«çš„ä»»åŠ¡ï¼Œç­‰ä»–å¥½äº†å†å›žæ¥å¤„ç†ã€‚

æ‰€ä»¥è¯´ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠä»»åŠ¡åˆ†ä¸ºä¸¤ç±»ï¼ŒåŒæ­¥(sync)ä»»åŠ¡ï¼Œå’Œå¼‚æ­¥(async)ä»»åŠ¡ã€‚åŒæ­¥ä»»åŠ¡æŒ‡çš„æ˜¯ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸ŠæŽ’é˜Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¿…é¡»å¾—æŒ‰é¡ºåºæ‰§è¡Œçš„äº†ã€‚å¼‚æ­¥ä»»åŠ¡æŒ‡çš„æ˜¯ï¼Œä¸è¿›å…¥ä¸»çº¿ç¨‹ï¼Œè€Œæ˜¯è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—(task queue)çš„ä»»åŠ¡ï¼Œåªæœ‰ä»»åŠ¡é˜Ÿåˆ—é€šçŸ¥ä¸»çº¿ç¨‹ï¼ŒæŸä¸ªå¼‚æ­¥ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œè¿™ä¸ªä»»åŠ¡æ‰ä¼šè¿›å…¥åˆ°ä¸»çº¿ç¨‹ä¸­ä¸­æ‰§è¡Œã€‚

ä¸‹é¢å¼•ç”¨é˜®ä¸€å³°çš„åšå®¢ï¼š

> å…·ä½“æ¥è¯´ï¼Œå¼‚æ­¥æ‰§è¡Œçš„è¿è¡Œæœºåˆ¶å¦‚ä¸‹ã€‚ï¼ˆåŒæ­¥æ‰§è¡Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«è§†ä¸ºæ²¡æœ‰å¼‚æ­¥ä»»åŠ¡çš„å¼‚æ­¥æ‰§è¡Œã€‚ï¼‰
>
> ï¼ˆ1ï¼‰æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆï¼ˆexecution context stackï¼‰ã€‚
> ï¼ˆ2ï¼‰ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª"ä»»åŠ¡é˜Ÿåˆ—"ï¼ˆtask queueï¼‰ã€‚åªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æžœï¼Œå°±åœ¨"ä»»åŠ¡é˜Ÿåˆ—"ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚
> ï¼ˆ3ï¼‰ä¸€æ—¦"æ‰§è¡Œæ ˆ"ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–"ä»»åŠ¡é˜Ÿåˆ—"ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å“ªäº›äº‹ä»¶ã€‚é‚£äº›å¯¹åº”çš„å¼‚æ­¥ä»»åŠ¡ï¼ŒäºŽæ˜¯ç»“æŸç­‰å¾…çŠ¶æ€ï¼Œè¿›å…¥æ‰§è¡Œæ ˆï¼Œå¼€å§‹æ‰§è¡Œã€‚
> ï¼ˆ4ï¼‰ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥ã€‚

## äº‹ä»¶ä¸Žå›žè°ƒå‡½æ•°

ä¸Šæ–‡æåˆ°ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­æ”¾ç½®çš„æ˜¯äº‹ä»¶ï¼Œå½“ IO è®¾å¤‡å®Œæˆä¸€é¡¹ä»»åŠ¡ï¼Œå°±ä¼šåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªäº‹ä»¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥äº§ç”Ÿä¸€äº›äº‹ä»¶ï¼Œåªè¦æŒ‡å®šè¿‡å›žè°ƒå‡½æ•°ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿæ—¶å°±ä¼šè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸»çº¿ç¨‹çš„è¯»å–ã€‚

> æ‰€è°“"å›žè°ƒå‡½æ•°"ï¼ˆcallbackï¼‰ï¼Œå°±æ˜¯é‚£äº›ä¼šè¢«ä¸»çº¿ç¨‹æŒ‚èµ·æ¥çš„ä»£ç ã€‚å¼‚æ­¥ä»»åŠ¡å¿…é¡»æŒ‡å®šå›žè°ƒå‡½æ•°ï¼Œå½“ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå°±æ˜¯æ‰§è¡Œå¯¹åº”çš„å›žè°ƒå‡½æ•°ã€‚

## äº‹ä»¶å¾ªçŽ¯

ä¸»çº¿ç¨‹ä»Žä»»åŠ¡é˜Ÿåˆ—ä¸­è¯»å–äº‹ä»¶çš„è¿‡ç¨‹æ˜¯å¾ªçŽ¯ä¸æ–­çš„ï¼Œæ‰€ä»¥è¯´è¿™æ•´ä¸ªè¿è¡Œæœºåˆ¶åˆè¢«ç§°ä¸ºäº‹ä»¶å¾ªçŽ¯(Event Loop)

## å®šæ—¶å™¨

ä»»åŠ¡é˜Ÿåˆ—ä¸­é™¤äº†å¼‚æ­¥ä»»åŠ¡ï¼Œè¿˜å¯ä»¥æ”¾ç½®å®šæ—¶äº‹ä»¶ï¼Œä¸€èˆ¬æ˜¯ setTimeout() å’Œ setInterval()ï¼Œä»–ä»¬çš„å†…éƒ¨è¿è¡Œæœºåˆ¶æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥åªè®¨è®º setTimeout()å°±å¯ä»¥ã€‚

```js
const { log } = console

log(1)
setTimeout(() => {
  log(2)
}, 100)
log(3)
```

è¾“å‡ºå¾ˆæ˜Žæ˜¾ï¼Œ132ï¼Œå› ä¸ºå®šæ—¶å™¨æŠŠ 2 å»¶è¿Ÿäº†ã€‚

```js
setTimeout(() => {
  log(1)
}, 0)
log(2)
```

é‚£æ— å»¶æ—¶çš„å®šæ—¶å™¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ 21ï¼Œè¿™è¡¨ç¤ºå½“å‰çš„æ‰§è¡Œæ ˆæ¸…ç©ºåŽï¼Œç«‹åˆ»æ‰§è¡ŒæŒ‡å®šçš„å›žè°ƒå‡½æ•°ã€‚

æ‰€ä»¥è¯´ï¼ŒsetTimeout(fn, 0) çš„å«ä¹‰å°±æ˜¯ï¼ŒæŒ‡å®šè¿™ä¸ªä»»åŠ¡åœ¨ä¸»çº¿ç¨‹æœ€æ—©å¯å¾—çš„ç©ºé—²æ—¶é—´æ‰§è¡Œã€‚

> HTML5 æ ‡å‡†è§„å®šäº† setTimeout()çš„ç¬¬äºŒä¸ªå‚æ•°çš„æœ€å°å€¼ï¼ˆæœ€çŸ­é—´éš”ï¼‰ï¼Œä¸å¾—ä½ŽäºŽ 4 æ¯«ç§’ï¼Œå¦‚æžœä½ŽäºŽè¿™ä¸ªå€¼ï¼Œå°±ä¼šè‡ªåŠ¨å¢žåŠ ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œè€ç‰ˆæœ¬çš„æµè§ˆå™¨éƒ½å°†æœ€çŸ­é—´éš”è®¾ä¸º 10 æ¯«ç§’ã€‚å¦å¤–ï¼Œå¯¹äºŽé‚£äº› DOM çš„å˜åŠ¨ï¼ˆå°¤å…¶æ˜¯æ¶‰åŠé¡µé¢é‡æ–°æ¸²æŸ“çš„éƒ¨åˆ†ï¼‰ï¼Œé€šå¸¸ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æ¯ 16 æ¯«ç§’æ‰§è¡Œä¸€æ¬¡ã€‚è¿™æ—¶ä½¿ç”¨ requestAnimationFrame()çš„æ•ˆæžœè¦å¥½äºŽ setTimeout()ã€‚
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒsetTimeout()åªæ˜¯å°†äº‹ä»¶æ’å…¥äº†"ä»»åŠ¡é˜Ÿåˆ—"ï¼Œå¿…é¡»ç­‰åˆ°å½“å‰ä»£ç ï¼ˆæ‰§è¡Œæ ˆï¼‰æ‰§è¡Œå®Œï¼Œä¸»çº¿ç¨‹æ‰ä¼šåŽ»æ‰§è¡Œå®ƒæŒ‡å®šçš„å›žè°ƒå‡½æ•°ã€‚è¦æ˜¯å½“å‰ä»£ç è€—æ—¶å¾ˆé•¿ï¼Œæœ‰å¯èƒ½è¦ç­‰å¾ˆä¹…ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰åŠžæ³•ä¿è¯ï¼Œå›žè°ƒå‡½æ•°ä¸€å®šä¼šåœ¨ setTimeout()æŒ‡å®šçš„æ—¶é—´æ‰§è¡Œã€‚

> æ³¨æ„ï¼š setTimeOut å¹¶ä¸æ˜¯ç›´æŽ¥çš„æŠŠä½ çš„å›žè°ƒå‡½æ•°æ”¾è¿›ä¸Šè¿°çš„å¼‚æ­¥é˜Ÿåˆ—ä¸­åŽ»ï¼Œè€Œæ˜¯åœ¨å®šæ—¶å™¨çš„æ—¶é—´åˆ°äº†ä¹‹åŽï¼ŒæŠŠå›žè°ƒå‡½æ•°æ”¾åˆ°æ‰§è¡Œå¼‚æ­¥é˜Ÿåˆ—ä¸­åŽ»ã€‚å¦‚æžœæ­¤æ—¶è¿™ä¸ªé˜Ÿåˆ—å·²ç»æœ‰å¾ˆå¤šä»»åŠ¡äº†ï¼Œé‚£å°±æŽ’åœ¨ä»–ä»¬çš„åŽé¢ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ setTimeOut ä¸ºä»€ä¹ˆä¸èƒ½ç²¾å‡†çš„æ‰§è¡Œçš„é—®é¢˜äº†ã€‚setTimeOut æ‰§è¡Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š
>
> ä¸»è¿›ç¨‹å¿…é¡»æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œå¦‚æžœåˆ°æ—¶é—´äº†ï¼Œä¸»è¿›ç¨‹ä¸ç©ºé—²ä¹Ÿä¸ä¼šæ‰§è¡Œä½ çš„å›žè°ƒå‡½æ•°ã€‚è¿™ä¸ªå›žè°ƒå‡½æ•°éœ€è¦ç­‰åˆ°æ’å…¥å¼‚æ­¥é˜Ÿåˆ—æ—¶å‰é¢çš„å¼‚æ­¥å‡½æ•°éƒ½æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šæ‰§è¡Œ

æ¥ä¿©ä¸ªä¾‹å­

```js
console.time('time')
setTimeout(() => {
  console.timeEnd('time')
}, 10)
// time: 10.6201171875 ms
```

è¿™æ ·å°±æ˜¯ç›¸å¯¹æ¯”è¾ƒå‡†æ—¶çš„

```js
console.time('time')
let i = 0
for (let j = 1; j < 100000; j++) i += j
setTimeout(() => {
  console.timeEnd('time')
}, 10)
// time: 14.416015625 ms
```

è¿™é‡Œå°±æ˜¯å› ä¸ºä¸Šé¢çš„å¾ªçŽ¯æ¶ˆè€—äº†è¾ƒå¤šçš„æ—¶é—´ï¼Œæ‰€ä»¥åœ¨å®šæ—¶å™¨æ—¶é—´åˆ°äº†ä¹‹åŽå¹¶æ²¡æœ‰ç«‹åˆ»æ‰§è¡Œå›žè°ƒå‡½æ•°ï¼Œè€Œæ˜¯ç­‰å¾…è€—æ—¶ä»»åŠ¡å®Œç»“ï¼Œæ‰åŽ»æ‰§è¡Œå›žè°ƒå‡½æ•°ã€‚

æ€»ç»“è¯´å°±æ˜¯ï¼Œå®šæ—¶å™¨çš„å›žè°ƒå‡½æ•°æ‰§è¡Œæ—¶é—´é—´éš” >=10msã€‚

## 1

## é¢˜ç›®

```js
async function async1() {
  console.log('async1 start')
  await async2()
  console.log('async1 end')
}
async function async2() {
  console.log('async2 start')
  return new Promise((resolve, reject) => {
    resolve()
    console.log('async2 promise')
  })
}
console.log('script start')
setTimeout(function () {
  console.log('setTimeout')
}, 0)
async1()

new Promise(function (resolve) {
  console.log('promise1')
  resolve()
})
  .then(function () {
    console.log('promise2')
  })
  .then(function () {
    console.log('promise3')
  })
console.log('script end')

// script start
// async1 start
// async2 start
// async2 promise
// promise1
// script end
// promise2
// promise3
// async1 end
// setTimeout
```
